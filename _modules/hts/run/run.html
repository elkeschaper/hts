<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>hts.run.run &mdash; HTS 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootswatch-3.3.6/united/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="HTS 0.0.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html"><img src="../../../_static/hts_logo.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>0.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../examples.html">Examples</a></li>
                <li><a href="http://example.com">Link</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/load_data__tutorial.html">Tutorial: Load data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/load_data__tutorial.html#Create-a-run-config-file.">Create a <code class="docutils literal"><span class="pre">run</span> <span class="pre">config</span></code> file.</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/gaussian_process_normalization_tutorial.html">Tutorial: Gaussian process normalization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/gaussian_process_normalization_tutorial.html#1.-Load-all-dependencies">1. Load all dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/gaussian_process_normalization_tutorial.html#2.-Read-in-your-high-throughput-screening-data">2. Read in your high throughput screening data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/gaussian_process_normalization_tutorial.html#3.-Perform-Gaussian-process-normalization">3. Perform Gaussian process normalization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/gaussian_process_normalization_tutorial.html#Write-the-normalized-data-to-a-file">Write the normalized data to a file</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/quality_control_reporting__tutorial.html">Tutorial: Create a Quality control report</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/quality_control_reporting__tutorial.html#Create-a-protocol_config-file.">Create a <code class="docutils literal"><span class="pre">protocol_config</span></code> file.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/quality_control_reporting__tutorial.html#Add-Quality-control-instructions-to-the-protocol_config-.">Add Quality control instructions to the <code class="docutils literal"><span class="pre">protocol_config</span></code> .</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/quality_control_reporting__tutorial.html#Connect-your-high-throughput-screening-data-set-to-the-protocol_config.">Connect your high-throughput screening data set to the <code class="docutils literal"><span class="pre">protocol_config</span></code>.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/quality_control_reporting__tutorial.html#Create-the-Quality-control-report:-Example">Create the Quality control report: Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/write_data__tutorial.html">Tutorial: Write data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/write_data__tutorial.html#Load-all-dependencies-and-load-your-data">Load all dependencies and load your data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/write_data__tutorial.html#Write-your-data">Write your data</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/data_normalization_tutorial.html">Tutorial: Data normalization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/data_normalization_tutorial.html#Read-in-your-high-throughput-screening-data">Read in your high throughput screening data</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for hts.run.run</h1><div class="highlight"><pre>
<span></span><span class="c1"># (C) 2015, 2016  Elke Schaper</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :synopsis: The Run Class.</span>

<span class="sd">    .. moduleauthor:: Elke Schaper &lt;elke.schaper@isb-sib.ch&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">configobj</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>

<span class="kn">from</span> <span class="nn">hts.data_tasks</span> <span class="kn">import</span> <span class="n">data_tasks</span><span class="p">,</span> <span class="n">gaussian_processes</span>
<span class="kn">from</span> <span class="nn">hts.plate_data.meta_data</span> <span class="kn">import</span> <span class="n">MetaData</span>
<span class="kn">from</span> <span class="nn">hts.run</span> <span class="kn">import</span> <span class="n">run_io</span>
<span class="kn">from</span> <span class="nn">hts.run.constants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">hts.plate</span> <span class="kn">import</span> <span class="n">plate</span>
<span class="kn">from</span> <span class="nn">hts.plate_data</span> <span class="kn">import</span> <span class="n">plate_layout</span>
<span class="kn">from</span> <span class="nn">hts.protocol</span> <span class="kn">import</span> <span class="n">protocol</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">KNOWN_DATA_TYPES</span> <span class="o">=</span> <span class="n">plate</span><span class="o">.</span><span class="n">KNOWN_DATA_TYPES</span>


<span class="c1">### Decorator</span>

<div class="viewcode-block" id="merged_replicates"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.merged_replicates">[docs]</a><span class="k">def</span> <span class="nf">merged_replicates</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="c1"># Organize pandas dataframes a) grouped_by replicates b) with one row per replicate.</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replicate_defining_column</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Groupby on data_frame with sample data only for replicates.</span>
        <span class="n">group_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_frame_samples</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">replicate_defining_column</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_merged_data_frame&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_merged_data_frame</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">replicate_defining_column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merged_data_frame</span><span class="p">:</span>
            <span class="c1"># Set up first aggregate. Add basic columns: [SAMPLE, SAMPLE_TYPE]</span>
            <span class="n">agg</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">[</span><span class="n">replicate_defining_column</span><span class="p">,</span> <span class="n">SAMPLE</span><span class="p">,</span> <span class="n">SAMPLE_TYPE</span><span class="p">]:</span>
                <span class="n">agg</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">column</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
            <span class="n">aggregate</span> <span class="o">=</span> <span class="n">group_by</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg</span><span class="p">)</span>
            <span class="n">aggregate</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># aggregate[RUN_HUMAN] = self.name # &lt;- This works if all runs are attached a name.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_merged_data_frame</span><span class="p">[</span><span class="n">replicate_defining_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregate</span>

        <span class="n">aggregate_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merged_data_frame</span><span class="p">[</span><span class="n">replicate_defining_column</span><span class="p">]</span>

        <span class="c1"># Calculate on group_by and aggregate. Return another aggregate.</span>
        <span class="n">aggregator</span> <span class="o">=</span> <span class="p">{</span><span class="n">replicate_defining_column</span><span class="p">:</span> <span class="p">{</span><span class="n">replicate_defining_column</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]}}</span>
        <span class="n">aggregate_new</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">group_by</span><span class="o">=</span><span class="n">group_by</span><span class="p">,</span>
                          <span class="n">aggregate</span><span class="o">=</span><span class="n">aggregate_old</span><span class="p">,</span>
                          <span class="n">aggregator</span><span class="o">=</span><span class="n">aggregator</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Combine the two aggregate dataframes.</span>
        <span class="c1"># Assume that we can merge on all columns that go by the same name.</span>
        <span class="n">common_column_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="nb">set</span><span class="p">(</span><span class="n">aggregate_old</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">aggregate_new</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
        <span class="n">aggregate_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">aggregate_old</span><span class="p">,</span> <span class="n">aggregate_new</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">common_column_names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_merged_data_frame</span><span class="p">[</span><span class="n">replicate_defining_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregate_merged</span>
        <span class="k">return</span> <span class="n">aggregate_merged</span>

    <span class="k">return</span> <span class="n">inner</span></div>


<span class="c1">### Run class</span>

<div class="viewcode-block" id="Run"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run">[docs]</a><span class="k">class</span> <span class="nc">Run</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; ``Run`` describes all information connected to one run of a high</span>
<span class="sd">        throughput screening experiment</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): Name of the run</span>
<span class="sd">        plates (collections.OrderedDict of ``Plate``): collections.OrderedDict of ``Plate`` instances</span>
<span class="sd">        width (int): Width of the plates</span>
<span class="sd">        height (int): Height of the plates</span>
<span class="sd">        _protocol (``Protocol``): ``Protocol`` instance</span>
<span class="sd">        _platelayout (``PlateLayout``): ``PlateLayout`` instance</span>
<span class="sd">        _qc (dict of dict of ``QualityControl`` instance): A collection of ``QualityControl`` instance</span>
<span class="sd">        raw_qc (``QualityControl``): ``QualityControl`` instance - NEEDED?</span>
<span class="sd">        net_qc (``QualityControl``): ``QualityControl`` instance - NEEDED?</span>
<span class="sd">        experimenter (str): Name of the experimenter</span>
<span class="sd">        experimenter (str): Mail address of the experimenter</span>


<span class="sd">    ..todo:: Implement me :)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Run.__str__"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create string for Run instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;Run instance&gt;</span><span class="se">\n</span><span class="s2">Path to run config file: {}</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;Number of plates: {}</span><span class="se">\n</span><span class="s2">width: {}</span><span class="se">\n</span><span class="s2">height: {}&quot;</span>
                   <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plates</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="s2">&quot;&lt;Run instance&gt;&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not create string of Run instance.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">run</span></div>

<div class="viewcode-block" id="Run.__iter__"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.__iter__">[docs]</a>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Iterates over plates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">plate_name</span><span class="p">,</span> <span class="n">plate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">plate</span></div>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plates</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plates</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plates</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">((</span><span class="n">plate</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">plate</span><span class="p">)</span> <span class="k">for</span> <span class="n">plate</span> <span class="ow">in</span> <span class="n">plates</span><span class="p">)</span>
        <span class="c1"># Plates as list: self.plates = plates</span>
        <span class="c1"># Later: Check if all plates are of the same height and length</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">plates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">plates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">height</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Could not discern plate width/height from first plate.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;protocol&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;protocol&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="o">==</span> <span class="n">configobj</span><span class="o">.</span><span class="n">Section</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;param for protocol is not of type &quot;</span>
                                <span class="s2">&quot;configobj.Section: {}, {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span> <span class="n">format</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>

        <span class="c1"># Save all other kwargs simply as attributes.</span>
        <span class="c1"># for key, value in kwargs.items():</span>
        <span class="c1">#    if not hasattr(self, key):</span>
        <span class="c1">#        setattr(self, key, value)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_data</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plates</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">((</span><span class="n">plate</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">plate</span><span class="p">)</span> <span class="k">for</span> <span class="n">plate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">():</span>
            <span class="c1"># Todo: Include check that plate layout is defined.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">()</span>


    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Run.create"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create ``Run`` instance.</span>

<span class="sd">        Create ``Run`` instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            origin (str):  At current only &quot;config&quot; or &quot;plates&quot;</span>
<span class="sd">            format (str):  Format of the origin, at current not specified</span>
<span class="sd">            path (str): Path to input file or directory</span>

<span class="sd">            dir (Bool): True if all files in directory shall be read, else false.</span>

<span class="sd">        .. todo:: Write checks for ``format`` and ``path``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="nb">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Run create directory {} does not exist.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">path</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Run create file {} does not exist.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;config&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">create_from_config</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;envision&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">create_from_envision</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">create_from_csv_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;pickle&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The combination of origin: {} and format: {} is &quot;</span>
                             <span class="s2">&quot;not implemented in &quot;</span>
                             <span class="s2">&quot;cls.create()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">format</span><span class="p">))</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Run.create_from_config"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.create_from_config">[docs]</a>    <span class="k">def</span> <span class="nf">create_from_config</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="nb">reload</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read config and use data to create `Run` instance.</span>

<span class="sd">        Read config and use data to create `Run` instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): Path to input configobj file</span>
<span class="sd">            file (str): Filename of configobj file</span>
<span class="sd">            force (boolean): If not force and the run instance exists as a pickle, reload the pickle instead of reloading the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">configobj</span><span class="o">.</span><span class="n">ConfigObj</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">),</span> <span class="n">stringify</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># If base_path is defined in config, automatically add the base to all paths.</span>
        <span class="k">if</span> <span class="s2">&quot;base_path&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">base_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;base_path&quot;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">walk_configobj_and_add_basepath</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="n">configobj</span><span class="o">.</span><span class="n">Section</span><span class="p">:</span>
                        <span class="n">walk_configobj_and_add_basepath</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;filepath_or_buffer&quot;</span><span class="p">:</span>
                            <span class="n">item</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                            <span class="n">node</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>

            <span class="n">walk_configobj_and_add_basepath</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>


        <span class="k">if</span> <span class="nb">reload</span><span class="o">==</span><span class="bp">False</span> <span class="ow">and</span> <span class="s2">&quot;write&quot;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="s2">&quot;pickle_path&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;write&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;write&quot;</span><span class="p">][</span><span class="s2">&quot;pickle_path&quot;</span><span class="p">]):</span>
            <span class="n">my_run</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;pickle&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;write&quot;</span><span class="p">][</span><span class="s2">&quot;pickle_path&quot;</span><span class="p">])</span>
            <span class="n">my_run</span><span class="o">.</span><span class="n">is_created_from_pickle</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="n">my_run</span>

        <span class="n">plate_names</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;plate_names&quot;</span><span class="p">]</span>
        <span class="n">n_plate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plate_names</span><span class="p">)</span>

        <span class="n">defined_data_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_type</span> <span class="k">for</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="n">KNOWN_DATA_TYPES</span> <span class="k">if</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="n">config</span><span class="p">]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">defined_data_types</span><span class="p">)</span>

        <span class="n">plates</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">config_plate_wise</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">plate_names</span><span class="p">]</span>
        <span class="n">additional_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="n">defined_data_types</span><span class="p">:</span>
            <span class="n">config_local</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">data_type</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_local</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">config_local</span><span class="p">))],</span> <span class="n">configobj</span><span class="o">.</span><span class="n">Section</span><span class="p">):</span>
                <span class="c1"># Multiple files for each plate are defined.</span>
                <span class="n">l_config_set</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">l_paths</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">l_tags</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">l_format</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">local_set</span><span class="p">,</span> <span class="n">config_set</span> <span class="ow">in</span> <span class="n">config_local</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">config_set</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">map_config_file_definition</span><span class="p">(</span><span class="n">config_set</span><span class="p">,</span> <span class="n">n_plate</span><span class="o">=</span><span class="n">n_plate</span><span class="p">)</span>
                    <span class="n">l_config_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config_set</span><span class="p">)</span>
                    <span class="n">l_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
                    <span class="n">l_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
                    <span class="n">l_format</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config_set</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">paths</span> <span class="ow">in</span> <span class="n">l_paths</span><span class="p">])</span> <span class="ow">and</span> <span class="n">n_plate</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Per datatype, one file for all plates</span>
                    <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;plate_layout&quot;</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">plate_layout</span><span class="o">.</span><span class="n">PlateLayout</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">paths</span><span class="o">=</span><span class="n">l_paths</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="n">l_format</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">l_tags</span><span class="p">,</span>
                                                               <span class="n">configs</span><span class="o">=</span><span class="n">l_config_set</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Reading in general info for data_type {} is not yet implemented.&quot;</span>
                                        <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_type</span><span class="p">))</span>
                    <span class="n">additional_data</span><span class="p">[</span><span class="n">data_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">elif</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_plate</span> <span class="k">for</span> <span class="n">paths</span> <span class="ow">in</span> <span class="n">l_paths</span><span class="p">]):</span>
                    <span class="c1"># Per datatype, one file for every plate</span>
                    <span class="k">for</span> <span class="n">i_plate</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_plate</span><span class="p">):</span>
                        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">i_plate</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l_paths</span><span class="p">]</span>
                        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">i_plate</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l_tags</span><span class="p">]</span>
                        <span class="n">config_plate_wise</span><span class="p">[</span><span class="n">i_plate</span><span class="p">][</span><span class="n">data_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;paths&quot;</span><span class="p">:</span> <span class="n">paths</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span> <span class="s2">&quot;formats&quot;</span><span class="p">:</span> <span class="n">l_format</span><span class="p">,</span>
                                                                 <span class="s2">&quot;configs&quot;</span><span class="p">:</span> <span class="n">l_config_set</span><span class="p">,</span>
                                                                 <span class="s2">&quot;types&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">config_local</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Currently option for multiple plates per plate data with some being one per plate &quot;</span>
                                    <span class="s2">&quot;and some one for all is not yet implemented.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Only a single file for each plate is defined.</span>
                <span class="n">config_local</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">map_config_file_definition</span><span class="p">(</span><span class="n">config_local</span><span class="p">,</span> <span class="n">n_plate</span><span class="o">=</span><span class="n">n_plate</span><span class="p">)</span>
                <span class="n">format</span> <span class="o">=</span> <span class="n">config_local</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">n_plate</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;plate_layout&quot;</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">plate_layout</span><span class="o">.</span><span class="n">PlateLayout</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">paths</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="p">[</span><span class="n">format</span><span class="p">],</span> <span class="o">**</span><span class="n">config_local</span><span class="p">)</span>
                        <span class="n">additional_data</span><span class="p">[</span><span class="n">data_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                    <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;readout&quot;</span> <span class="ow">and</span> <span class="n">format</span> <span class="o">==</span> <span class="s2">&quot;csv_one_well_per_row&quot;</span><span class="p">:</span>
                        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">config_local</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">))</span>
                        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">config_local</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">))</span>
                        <span class="n">plates</span> <span class="o">=</span> <span class="n">run_io</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="o">**</span><span class="n">config_local</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Reading in general info for data_type {} is not yet implemented.&quot;</span>
                                        <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_type</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i_plate</span><span class="p">,</span> <span class="p">(</span><span class="n">i_path</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">tags</span><span class="p">)):</span>
                        <span class="n">config_local</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;paths&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i_path</span><span class="p">],</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">tag</span><span class="p">],</span> <span class="s2">&quot;formats&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">format</span><span class="p">]})</span>
                        <span class="n">config_plate_wise</span><span class="p">[</span><span class="n">i_plate</span><span class="p">][</span><span class="n">data_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
                            <span class="n">config_local</span><span class="p">)</span>  <span class="c1"># For current shallow dicts, config_local.copy() is ok.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">plates</span><span class="p">:</span>
            <span class="c1"># plate.Plate.create expects: formats, paths, configs = None, names=None, tags=None</span>
            <span class="n">plates</span> <span class="o">=</span> <span class="p">[</span><span class="n">plate</span><span class="o">.</span><span class="n">Plate</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">plate_name</span><span class="p">,</span> <span class="o">**</span><span class="n">config_plate</span><span class="p">)</span> <span class="k">for</span> <span class="n">config_plate</span><span class="p">,</span> <span class="n">plate_name</span>
                      <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">config_plate_wise</span><span class="p">,</span> <span class="n">plate_names</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">additional_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i_plate</span> <span class="ow">in</span> <span class="n">plates</span><span class="p">:</span>
                <span class="n">i_plate</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># Data: may be all in one file (csv .xlxs), or in separated .csv files (default case, e.g. .csv)</span>
        <span class="c1"># Data: In particular for readouts, there may be several sets of data (e.g. Readouts for different points in time.)</span>

        <span class="c1"># if len(data_types_plate_wise) == 0:</span>
        <span class="c1">#    raise Exception(&quot;No plate wise information was defined in Run config.&quot;)</span>


        <span class="c1"># Check if the number of files is equal for all data_types_plate_wise:</span>

        <span class="k">return</span> <span class="n">Run</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">),</span> <span class="n">plates</span><span class="o">=</span><span class="n">plates</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Run.map_config_file_definition"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.map_config_file_definition">[docs]</a>    <span class="k">def</span> <span class="nf">map_config_file_definition</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">n_plate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Extract the files from the config file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">config_file</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;filenames&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;filenumber&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">config</span><span class="p">}</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_plate</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">config_file</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;filenames&quot;</span><span class="p">]):</span>  <span class="c1"># &quot;filenames&quot; predominates &quot;filename&quot;, &quot;filenumber&quot;</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_file</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="n">i_file</span><span class="p">)</span> <span class="k">for</span> <span class="n">i_file</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;filenames&#39;</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">config_file</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;filenumber&quot;</span><span class="p">]):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_file</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="n">config_file</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_index</span><span class="p">))</span> <span class="k">for</span> <span class="n">i_index</span> <span class="ow">in</span>
                     <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;filenumber&#39;</span><span class="p">]]</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;filenumber&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">config_file</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">]):</span>
            <span class="c1"># In reality, we are in this case only dealing with one file, in which the information for all plates is stored.</span>
            <span class="c1"># For these cases, for now, we pass the path information in hidden as config[&quot;file&quot;]</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;path&quot;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">:</span>
            <span class="c1"># There is only one file defined. We assumed it is defined for all plates.</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">config_file</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]]</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not enough information given to decipher data files.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_plate</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The number of user defined files {} is not equal to &quot;</span>
                            <span class="s2">&quot;the user defined n_plate {} nor 1.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">n_plate</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">config</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">tags</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Run.create_from_envision"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.create_from_envision">[docs]</a>    <span class="k">def</span> <span class="nf">create_from_envision</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read envision data and create `Run` instance.</span>

<span class="sd">        Read envision data and create `Run` instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): Path to input configobj file</span>
<span class="sd">            file (str): Filename of configobj file</span>

<span class="sd">        .. todo:: Write checks if path and file exists when necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="p">[</span><span class="nb">file</span><span class="p">]</span>

        <span class="n">plates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_file</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;readout&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;paths&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">i_file</span><span class="p">)],</span> <span class="s2">&quot;formats&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;envision_csv&quot;</span><span class="p">]}}</span>
            <span class="n">plates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plate</span><span class="o">.</span><span class="n">Plate</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Run</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">plates</span><span class="o">=</span><span class="n">plates</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Run.create_from_csv_file"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.create_from_csv_file">[docs]</a>    <span class="k">def</span> <span class="nf">create_from_csv_file</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read csv data and create `Run` instance.</span>

<span class="sd">        Read csv data and create `Run` instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): Path to input csv file</span>
<span class="sd">            file (str): Filename of csv file</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">plates</span> <span class="o">=</span> <span class="n">run_io</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Run</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">plates</span><span class="o">=</span><span class="n">plates</span><span class="p">)</span></div>

<div class="viewcode-block" id="Run.filter"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Filter run data according to filter keyword arguments.</span>

<span class="sd">        Filter run data according to filter arguments. The values for each plates are concatenated.</span>

<span class="sd">        Args:</span>
<span class="sd">            kwargs: Keyword arguments for filtering.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list of floats</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">plate</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">plate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plates</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="c1"># return [item for sublist in data for item in sublist]</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Run.preprocess"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.preprocess">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Perform data preprocessing.</span>

<span class="sd">        Perform data preprocessing.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">get_tasks_by_tag</span><span class="p">(</span><span class="s2">&quot;preprocessing&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i_plate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plates</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">i_plate</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">task</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No preprocessing tasks defined in protocol: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>

<div class="viewcode-block" id="Run.get_run_config_data"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.get_run_config_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_run_config_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Extract relevant meta data for qc and analysis reports.</span>
<span class="sd">            Returns list of tuples: [(key_str, value_str)]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># You could try to flatten the dict automagically to increase elegance:</span>
        <span class="c1"># http://stackoverflow.com/questions/6027558/flatten-nested-python-dictionaries-compressing-keys</span>
        <span class="n">config_data_order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;protocol_name&quot;</span><span class="p">,</span> <span class="s2">&quot;protocol_file&quot;</span><span class="p">,</span> <span class="s2">&quot;experimenter&quot;</span><span class="p">,</span> <span class="s2">&quot;experimenter_mail&quot;</span><span class="p">,</span> <span class="s2">&quot;run_config&quot;</span><span class="p">]</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;qc&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="n">configobj</span><span class="o">.</span><span class="n">Section</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">])]</span> <span class="o">=</span> <span class="n">l</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">config_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
        <span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;protocol_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
        <span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;protocol_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">file</span>
        <span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;run_config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">config_data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">config_data_ordered</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i_o</span><span class="p">,</span> <span class="n">config_data</span><span class="p">[</span><span class="n">i_o</span><span class="p">])</span> <span class="k">for</span> <span class="n">i_o</span> <span class="ow">in</span> <span class="n">config_data_order</span><span class="p">]</span>
        <span class="n">config_data_ordered</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">i_m</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_v</span><span class="p">))</span> <span class="k">for</span> <span class="n">i_m</span><span class="p">,</span> <span class="n">i_v</span> <span class="ow">in</span> <span class="n">config_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">i_m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_data_order</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">config_data_ordered</span></div>

<div class="viewcode-block" id="Run.do_task"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.do_task">[docs]</a>    <span class="k">def</span> <span class="nf">do_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">type_attribute</span><span class="o">=</span><span class="s2">&quot;_{}&quot;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Perform task. A task could be e.g. qc or analysis.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">type_attribute</span> <span class="o">=</span> <span class="n">type_attribute</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_attribute</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_attribute</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">get_tasks_by_tag</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="n">methods_from_protocol</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">configobj</span><span class="o">.</span><span class="n">Section</span><span class="p">)])</span>
            <span class="n">config_data_from_protocol</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">configobj</span><span class="o">.</span><span class="n">Section</span><span class="p">)])</span>
            <span class="c1"># This will work Python 3.5 onwards: return {**config_data_from_protocol, **self.config_data[task.name]}</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_data</span><span class="p">:</span>
                <span class="n">config_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config_data_from_protocol</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config_data</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">config_data</span> <span class="o">=</span> <span class="n">config_data_from_protocol</span>
            <span class="n">result</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_tasks</span><span class="o">.</span><span class="n">perform_task</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                        <span class="n">task_name</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                                                        <span class="n">methods</span><span class="o">=</span><span class="n">methods_from_protocol</span><span class="p">,</span>
                                                        <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span>
                                                        <span class="c1">#config_data=self.get_run_config_data(), # &lt;- Perhaps this is necessary for QC or other methods?</span>
                                                        <span class="o">**</span><span class="n">config_data</span><span class="p">)</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_attribute</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Run.qc"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.qc">[docs]</a>    <span class="k">def</span> <span class="nf">qc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Perform quality control and save the results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_task</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;qc&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;send_mail_upon_qc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;send_mail_upon_qc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
            <span class="n">send_mail</span><span class="p">(</span><span class="n">email_to</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config_data</span><span class="p">[</span><span class="s1">&#39;experimenter_mail&#39;</span><span class="p">]],</span>
                      <span class="n">body</span><span class="o">=</span><span class="s2">&quot;QC report for Run config &#39;{}&#39; is prepared.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">qc</span></div>

<div class="viewcode-block" id="Run.analysis"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.analysis">[docs]</a>    <span class="k">def</span> <span class="nf">analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Perform analysis and save the results.</span>

<span class="sd">        Perform analysis and save the results. Parameters are taken from the protocol and the run config. Each</span>
<span class="sd">        ProtocolTask tagged with &quot;analysis&quot; is run. Each ProtocolTask may be run multiple times, if several dicts</span>
<span class="sd">        are defined for it (this could be either in protocol, or in the run config.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_task</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;analysis&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">analysis</span></div>

<div class="viewcode-block" id="Run.protocol"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.protocol">[docs]</a>    <span class="k">def</span> <span class="nf">protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read protocol and attach to `Run` instance.</span>

<span class="sd">        Read protocol and attach to `Run` instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): Path to input file</span>
<span class="sd">            format (str):  At current only &quot;csv&quot;</span>

<span class="sd">        .. todo:: Write checks if path and format exists when necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_protocol&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">format</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">format</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span></div>

<div class="viewcode-block" id="Run.write"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">return_string</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Serialize and write ``Run`` instances.</span>

<span class="sd">        Serialize ``Run`` instance using the stated ``format``.</span>

<span class="sd">        Args:</span>
<span class="sd">            format (str):  The output format: Currently only &quot;pickle&quot;.</span>
<span class="sd">            path (str): Path to output file</span>

<span class="sd">        .. todo:: Write checks for ``format`` and ``path``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">format</span> <span class="o">==</span> <span class="s1">&#39;pickle&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;write&quot;</span><span class="p">][</span><span class="s2">&quot;pickle_path&quot;</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;path neither defined explictely nor, in in self.config_data&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">run_io</span><span class="o">.</span><span class="n">serialize_run_for_r</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s1">&#39;csv_one_well_per_row&#39;</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">run_io</span><span class="o">.</span><span class="n">serialize_as_csv_one_row_per_well</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s1">&#39;serialize_as_pandas&#39;</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">run_io</span><span class="o">.</span><span class="n">serialize_as_pandas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Format is unknown: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">format</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_string</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span></div>

    <span class="c1">###### Handle Run data as a pandas.data_frame:</span>
    <span class="c1">## - less or no emphasis on plate_layout structure</span>
    <span class="c1">## - calculations that are oblivous of plate_layout may want to go here.</span>
    <span class="c1">## - one data_frame row per well or per sample</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_data_frame&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;serialize_as_pandas&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">return_string</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_frame</span>

    <span class="nd">@data_frame.setter</span>
    <span class="k">def</span> <span class="nf">data_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_frame</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_frame_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_data_frame_samples&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_frame_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_frame</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_frame</span><span class="o">.</span><span class="n">sample_type</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_frame_samples</span>

    <span class="nd">@data_frame_samples.setter</span>
    <span class="k">def</span> <span class="nf">data_frame_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_frame_samples</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Run.add_meta_data"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.add_meta_data">[docs]</a>    <span class="k">def</span> <span class="nf">add_meta_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set self.data_frame to merged internal and meta_data.</span>

<span class="sd">        Args:</span>
<span class="sd">            tag: The meta data tag defining which meta data to use. If `tag` is not set and there is only one set of meta data it will be used.</span>
<span class="sd">            **kwargs: kwargs passed on to `run_io.add_meta_data`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;meta_data&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">config_data</span> <span class="o">=</span> <span class="nb">next</span> <span class="p">(</span><span class="nb">iter</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;meta_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;There is more than one set of meta_data: {}. Define which one to add.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;meta_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">config_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;meta_data&quot;</span><span class="p">][</span><span class="n">tag</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No meta_data {} available. Add the meta_data, or choose another tag.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">config_data</span><span class="p">)</span>
        <span class="n">merged_data</span> <span class="o">=</span> <span class="n">run_io</span><span class="o">.</span><span class="n">add_meta_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                           <span class="n">meta_data_kwargs</span><span class="o">=</span><span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;data_kwargs&quot;</span><span class="p">],</span>
                                           <span class="n">meta_data_rename</span><span class="o">=</span><span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;rename_columns&quot;</span><span class="p">],</span>
                                           <span class="n">meta_data_exclude_columns</span><span class="o">=</span><span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;exclude_columns&quot;</span><span class="p">],</span>
                                           <span class="n">meta_data_well_name_pattern</span><span class="o">=</span><span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;well_name_pattern&quot;</span><span class="p">],</span>
                                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_frame</span> <span class="o">=</span> <span class="n">merged_data</span></div>

<div class="viewcode-block" id="Run.add_data_from_data_frame"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.add_data_from_data_frame">[docs]</a>    <span class="k">def</span> <span class="nf">add_data_from_data_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">plate_data_type</span><span class="o">=</span><span class="s2">&quot;meta_data&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            tags (list of str): HTS data and meta data is joined on the columns defined by tags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_frame</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">plate</span><span class="p">:</span> <span class="p">{</span><span class="n">tag</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">}</span> <span class="k">for</span> <span class="n">plate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plates</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">readout</span><span class="p">,</span> <span class="n">plate_name</span><span class="p">,</span> <span class="n">i_column</span><span class="p">,</span> <span class="n">i_row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">PLATE_HUMAN</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">WELL_COLUMN_MACHINE</span><span class="p">],</span>
                                                            <span class="n">df</span><span class="p">[</span><span class="n">WELL_ROW_MACHINE</span><span class="p">]):</span>
                <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">plates</span><span class="p">[</span><span class="n">plate_name</span><span class="p">]][</span><span class="n">tag</span><span class="p">][(</span><span class="n">i_row</span><span class="p">,</span> <span class="n">i_column</span><span class="p">)]</span> <span class="o">=</span> <span class="n">readout</span>

        <span class="k">for</span> <span class="n">plate</span><span class="p">,</span> <span class="n">plate_data</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># ToDo: Allow creation of any type of PlateData (e.g. via registries).</span>
            <span class="n">meta_data</span> <span class="o">=</span> <span class="n">MetaData</span><span class="o">.</span><span class="n">create_from_coordinate_tuple_dict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">plate_data</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                                                   <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
            <span class="n">plate</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">meta_data</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">plate_data_type</span><span class="p">)</span></div>


    <span class="nd">@merged_replicates</span>
<div class="viewcode-block" id="Run.merger_add_data_from_data_frame"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.merger_add_data_from_data_frame">[docs]</a>    <span class="k">def</span> <span class="nf">merger_add_data_from_data_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_by</span><span class="p">,</span> <span class="n">aggregator</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Add data from other columns</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">aggregator</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">column</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="c1"># Calculate for every group.</span>
        <span class="n">aggregated_dataframe</span> <span class="o">=</span> <span class="n">group_by</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">aggregator</span><span class="p">)</span>
        <span class="n">aggregated_dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">aggregated_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">aggregated_dataframe</span></div>

    <span class="nd">@merged_replicates</span>
<div class="viewcode-block" id="Run.merger_summarize_statistical_significance"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.merger_summarize_statistical_significance">[docs]</a>    <span class="k">def</span> <span class="nf">merger_summarize_statistical_significance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_by</span><span class="p">,</span> <span class="n">aggregator</span><span class="p">,</span>
                                                  <span class="n">data_tag_readouts_to_aggregate</span><span class="p">,</span>
                                                  <span class="n">data_tag_pvalues_to_aggregate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                                  <span class="n">data_tag_standard_scores_to_aggregate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1">## Define all aggregation methods.</span>

        <span class="c1"># 1. Aggregate normalized values.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_tag_readouts_to_aggregate</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_frame</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Required columns not available:</span><span class="se">\n</span><span class="s2">{}</span><span class="se">\n</span><span class="s2">readouts:{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_frame</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">data_tag_readouts_to_aggregate</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="k">for</span> <span class="n">data_tag</span> <span class="ow">in</span> <span class="n">data_tag_readouts_to_aggregate</span><span class="p">:</span>
            <span class="n">aggregator</span><span class="p">[</span><span class="n">data_tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">data_tag</span> <span class="o">+</span> <span class="s1">&#39;_mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
                                    <span class="n">data_tag</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">}</span>

        <span class="c1"># 2. Aggregate pvalues.</span>
        <span class="k">def</span> <span class="nf">fishers_method</span><span class="p">(</span><span class="n">pvalues</span><span class="p">):</span>
            <span class="c1"># Aggregate pvalues using Fisher&#39;s method: https://en.wikipedia.org/wiki/Fisher&#39;s_method</span>
            <span class="n">statistic</span><span class="p">,</span> <span class="n">pval</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">combine_pvalues</span><span class="p">(</span><span class="n">pvalues</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pval</span>

        <span class="k">if</span> <span class="n">data_tag_pvalues_to_aggregate</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_tag_pvalues_to_aggregate</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_frame</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Required columns not available:</span><span class="se">\n</span><span class="s2">{}</span><span class="se">\n</span><span class="s2">pvalues:{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_frame</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                                                                        <span class="n">data_tag_pvalues_to_aggregate</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span>
            <span class="k">for</span> <span class="n">data_tag</span> <span class="ow">in</span> <span class="n">data_tag_pvalues_to_aggregate</span><span class="p">:</span>
                <span class="n">aggregator</span><span class="p">[</span><span class="n">data_tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">data_tag</span><span class="p">:</span> <span class="n">fishers_method</span><span class="p">}</span>

        <span class="c1"># 3. Aggregate standard scores / z-scores.</span>
        <span class="k">def</span> <span class="nf">stouffers_z_score_method</span><span class="p">(</span><span class="n">standard_scores</span><span class="p">):</span>
            <span class="c1"># Aggregate pvalues using Stouffer&#39;s z-score method for one-sided tests: https://en.wikipedia.org/wiki/Fisher&#39;s_method</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">standard_scores</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">standard_scores</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">z</span>

        <span class="k">if</span> <span class="n">data_tag_standard_scores_to_aggregate</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_tag_standard_scores_to_aggregate</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_frame</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Required columns not available:</span><span class="se">\n</span><span class="s2">{}</span><span class="se">\n</span><span class="s2">standard_scores:{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_frame</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                                                                        <span class="n">data_tag_standard_scores_to_aggregate</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span>
            <span class="k">for</span> <span class="n">data_tag</span> <span class="ow">in</span> <span class="n">data_tag_standard_scores_to_aggregate</span><span class="p">:</span>
                <span class="n">aggregator</span><span class="p">[</span><span class="n">data_tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">data_tag</span><span class="p">:</span> <span class="n">stouffers_z_score_method</span><span class="p">}</span>

        <span class="c1"># Execute all aggregation methods at once for every aggregate (group).</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aggregated_dataframe</span> <span class="o">=</span> <span class="n">group_by</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">aggregator</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;What goes wrong here?. Columns in readout: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_frame</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="n">aggregated_dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">aggregated_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">aggregated_dataframe</span></div>

    <span class="nd">@merged_replicates</span>
<div class="viewcode-block" id="Run.merger_rank_samples"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.Run.merger_rank_samples">[docs]</a>    <span class="k">def</span> <span class="nf">merger_rank_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">,</span>
                            <span class="n">ranking_column</span><span class="p">,</span> <span class="n">rank_column_name</span><span class="p">,</span> <span class="n">rank_threshold</span><span class="p">,</span> <span class="n">is_hit_by_rank_column_name</span><span class="p">,</span>
                            <span class="n">value_threshold</span><span class="p">,</span> <span class="n">is_hit_by_value_column_name</span><span class="p">,</span> <span class="n">is_one_sided</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Add a ranking by `ranking_column`</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aggregate</span><span class="p">[</span><span class="n">rank_column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregate</span><span class="p">[</span><span class="n">ranking_column</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_one_sided</span><span class="p">:</span>
            <span class="c1"># Marking ranks as True or False only makes sense for one-sided tests.</span>
            <span class="n">aggregate</span><span class="p">[</span><span class="n">is_hit_by_rank_column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregate</span><span class="p">[</span><span class="n">rank_column_name</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">rank_threshold</span> <span class="k">else</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">aggregate</span><span class="p">[</span><span class="n">is_hit_by_value_column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregate</span><span class="p">[</span><span class="n">ranking_column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">value_threshold</span> <span class="k">else</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Here, we assume that x is a probability, with counter probability 1-x.</span>
            <span class="n">aggregate</span><span class="p">[</span><span class="n">is_hit_by_value_column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregate</span><span class="p">[</span><span class="n">ranking_column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">value_threshold</span> <span class="ow">or</span> <span class="mi">1</span><span class="o">-</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">value_threshold</span> <span class="k">else</span> <span class="bp">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">aggregate</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gp_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_gp_model&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gp_model</span> <span class="o">=</span> <span class="n">gaussian_processes</span><span class="o">.</span><span class="n">GaussianProcesses</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="p">[])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gp_model</span>


    <span class="nd">@gp_models.setter</span>
    <span class="k">def</span> <span class="nf">gp_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gp_model</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="send_mail"><a class="viewcode-back" href="../../../hts.run.html#hts.run.run.send_mail">[docs]</a><span class="k">def</span> <span class="nf">send_mail</span><span class="p">(</span><span class="n">body</span><span class="p">,</span>
              <span class="n">email_to</span><span class="p">,</span>
              <span class="n">email_from</span><span class="o">=</span><span class="s2">&quot;adriano_conrad_aguzzi@gmail.com&quot;</span><span class="p">,</span>
              <span class="n">smtp_server</span><span class="o">=</span><span class="s2">&quot;smtp.gmail.com&quot;</span><span class="p">,</span>
              <span class="n">smtp_port</span><span class="o">=</span><span class="mi">587</span><span class="p">,</span>
              <span class="n">smtp_username</span><span class="o">=</span><span class="s2">&quot;elkewschaper@gmail.com&quot;</span><span class="p">,</span>
              <span class="n">email_subject</span><span class="o">=</span><span class="s2">&quot;QC_report finished&quot;</span><span class="p">):</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sending email to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">email_to</span><span class="p">))</span>

    <span class="kn">from</span> <span class="nn">email.mime.text</span> <span class="kn">import</span> <span class="n">MIMEText</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
    <span class="kn">import</span> <span class="nn">smtplib</span>

    <span class="n">smtp_password</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter password for {}:  &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">smtp_username</span><span class="p">))</span>
    <span class="c1"># email_from = smtp_username</span>

    <span class="n">DATE_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y&quot;</span>
    <span class="n">EMAIL_SPACE</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;text/html; charset=UTF8&#39;</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email_subject</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">DATE_FORMAT</span><span class="p">))</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email_from</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMAIL_SPACE</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">email_to</span><span class="p">)</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">smtp_server</span><span class="p">,</span> <span class="n">smtp_port</span><span class="p">)</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">starttls</span><span class="p">()</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">smtp_username</span><span class="p">,</span> <span class="n">smtp_password</span><span class="p">)</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">email_from</span><span class="p">,</span> <span class="n">email_to</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2016, Elke Schaper for Vital-IT, SIB.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>